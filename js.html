<script>
  const app = Vue.createApp({
    data: ()=>({
      searchWords: "",
      pageNum: 0,
      message: "",
      // loading: false, 
      items: null,
      andOrOption: "OR", // html側でchecked入れててもデフォルトは空文字らしいので
      includeAuthorName: false,
      hiraganaMode: false,
      // ヘッダ―情報　サーバサイドにも渡すけどここにベタ書きしてるのはなんか違う気がする
      tableHeader: [
        {"name": "本の名前", "thWidth": "w-2/5"},
        {"name": "人名", "thWidth": "w-1/4"},
        {"name":"出版者", "thWidth": "w-1/5"},
        {"name": "分類", "thWidth": "w-1/6"},
      ],
      tableHeaderWidths: ["w-2/5", "w-1/4", "w-1/5", "w-1/6"],
      sheetHeader: [
        "title", "author", "publisher", "genre", 
      ],

      // ヘッダーロゴ用のGoogleドライブ上の画像ファイルのID
      fileId: "公開設定にした画像ファイルID",
      // ヘッダーロゴ
      logoImg: null,

      // ページネーション用？ 初期値, 最初, 中間, 最後
      // null, onFirstPage, onMidPage, onLastPage
      paginateState: null,

      // ページネーション改修してみる 状態は3つ(エラーは数えないものとする)
      // 算出プロパティにしようかと思ったが、値を返す必要がないので、
      // watchでいいかもしれない　のでそうしてみる
      paginateState2: "ready",
    }),

    /*
    computed:{
      pagenator: {
        get: function(){
          return this.paginateState2;
        },
        set: function(state){
          this.paginateState2 = state;
        }
      } 
    },
    */
    watch: {
      paginateState2: function(curExpectedState, oldState){
        if(curExpectedState === "loading"){
          this.message = "けんさくちゅう...";
        }else if(curExpectedState === "viewingResult"){
          this.message = "けんさくけっか！";
        }else if(curExpectedState === "ready"){

        }else{
          console.log("ページネーション用の状態管理でここにくることなくない？");
        }
      },
    },

    methods: {
      updatePageState: function(sheetData){
        console.log(`items`);
        console.log(this.items);
        console.log(`count: ${sheetData.resultNum}`);
        console.log(`curpage: ${sheetData.curPage}`);
        console.log(`maxpage: ${sheetData.maxPage}`);

        if(parseInt(sheetData.resultNum) < parseInt(sheetData.countLimit)){
          this.paginateState = null;
        }else if(parseInt(sheetData.curPage) === 1){
          this.paginateState = "onFirstPage";         
        }else if(parseInt(sheetData.maxPage) === parseInt(sheetData.curPage)){
          this.paginateState = "onLastPage";
        }else if(1 < parseInt(sheetData.curPage) && parseInt(sheetData.curPage) < parseInt(sheetData.maxPage)){
          this.paginateState = "onMidPage"
        }else{
          console.log(`???`);
        }
      },
      prePage: async function(){
        console.log(`prev page`);
        this.pageNum =  parseInt(Math.max(this.pageNum-1, 0));
        const sheetData = await this.searchData();
        this.items = sheetData.data;
        this.updatePageState(sheetData);
      },
      nexPage: async function(){
        console.log(`nex page`);
        this.pageNum++;
        const sheetData = await this.searchData();
        this.items = sheetData.data;
        this.updatePageState(sheetData);
      },
      loadData: async function(event){
        // 検索開始 = 1ページ目から表示
        this.pageNum = 1;
        // this.paginateState = null;
        // this.paginateState2 = "loading";
        const sheetData = await this.searchData();
        this.items = sheetData.data;
        this.updatePageState(sheetData);
      },

      searchData: function(){
        this.message = "けんさくちゅう...";
        this.loading = true;
        const seachOptions = {
          "header": this.sheetHeader,
          "words": this.searchWords,
          "page": this.pageNum,
          "andOrOption": this.andOrOption,
          "includeAuthorName": this.includeAuthorName,
        };
        return new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler((result) => {
              this.message = "けんさくけっか！";
              this.loading = false;
              resolve(result);
            })
            .withFailureHandler((error) => {
              console.log(error);
              reject(error);
            })
            .search(JSON.stringify(seachOptions));
        });
      },
    },
    created: function(){
      // apps script側でテーブルのやつ叩いとく
        google.script.run
          .withSuccessHandler((result) => {
            console.log(`was table created?`);
            console.log(result);
            // resolve(result);
          })
          .withFailureHandler((error) => {
            console.log(`omg some error occured when creating table...`);
            console.log(error);
            reject(error);
          })
          .genGenreTable();

        // logo image
        google.script.run
          .withSuccessHandler(result => {
            console.log("success:");
            this.logoImg = result;
          })
          .withFailureHandler(err =>{
            console.error(err);
            // alert(`ERROR!!!!\n${err}`);
            this.logoImg = "https://4.bp.blogspot.com/-gUQWvlEhd90/WR_LT3yiH0I/AAAAAAABEfE/87r5mxWuTCYiufU3zurk5dhm-oaOyKS_QCLcB/s800/text_pop_koukai.png";
          })
          .getBase64UrlOnDriveImage(this.fileId);
    },
  });


  app.mount("#app")
</script>
